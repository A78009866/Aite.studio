name: Aite Studio APK Builder
on:
  repository_dispatch:
    types: [build-apk]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Install Image Tools
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Build System Setup
        run: |
          RAW_PKG="${{ github.event.client_payload.package_name }}"
          CLEAN_PKG=$(echo "$RAW_PKG" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9.')
          [ -z "$CLEAN_PKG" ] && CLEAN_PKG="com.aite.app"

          mkdir -p app/src/main/res/mipmap-mdpi app/src/main/res/mipmap-hdpi app/src/main/res/mipmap-xhdpi app/src/main/res/mipmap-xxhdpi app/src/main/res/mipmap-xxxhdpi
          mkdir -p gradle/wrapper app/src/main/res/xml app/src/main/java/com/aite/studio app/src/main/res/layout
          
          curl -L https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar
          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip" > gradle/wrapper/gradle-wrapper.properties

          cat <<EOF > app/build.gradle
          plugins { 
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android' 
          }
          android {
              namespace 'com.aite.studio'
              compileSdk 34
              defaultConfig {
                  applicationId "$CLEAN_PKG"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              compileOptions { 
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17 
              }
              kotlinOptions { jvmTarget = '17' }
          }
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.activity:activity-ktx:1.8.0'
          }
          EOF

          PERMISSIONS=""
          if [ "${{ github.event.client_payload.use_camera }}" == "true" ]; then
            PERMISSIONS+='<uses-permission android:name="android.permission.CAMERA" />\n'
          fi
          if [ "${{ github.event.client_payload.use_mic }}" == "true" ]; then
            PERMISSIONS+='<uses-permission android:name="android.permission.RECORD_AUDIO" />\n<uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />\n'
          fi
          if [ "${{ github.event.client_payload.use_location }}" == "true" ]; then
            PERMISSIONS+='<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />\n<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />\n'
          fi
          if [ "${{ github.event.client_payload.use_files }}" == "true" ]; then
            PERMISSIONS+='<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />\n<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />\n'
          fi
          if [ "${{ github.event.client_payload.use_notifications }}" == "true" ]; then
            PERMISSIONS+='<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />\n'
          fi

          cat <<EOF > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              $(echo -e "$PERMISSIONS")
              
              <application
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher"
                  android:label="${{ github.event.client_payload.app_name }}"
                  android:theme="@style/Theme.AppCompat.Light.NoActionBar"
                  android:usesCleartextTraffic="true">
                  
                  <activity 
                      android:name="com.aite.studio.MainActivity" 
                      android:exported="true"
                      android:configChanges="orientation|screenSize|keyboardHidden">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <provider
                      android:name="androidx.core.content.FileProvider"
                      android:authorities="\${applicationId}.fileprovider"
                      android:exported="false"
                      android:grantUriPermissions="true">
                      <meta-data
                          android:name="android.support.FILE_PROVIDER_PATHS"
                          android:resource="@xml/file_paths" />
                  </provider>
              </application>
          </manifest>
          EOF
          
          cat <<EOF > app/src/main/res/xml/file_paths.xml
          <?xml version="1.0" encoding="utf-8"?>
          <paths xmlns:android="http://schemas.android.com/apk/res/android">
              <external-path name="external_files" path="."/>
          </paths>
          EOF

          # Create activity_main.xml for the WebView
          cat <<EOF > app/src/main/res/layout/activity_main.xml
          <?xml version="1.0" encoding="utf-8"?>
          <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent">

              <WebView
                  android:id="@+id/webView"
                  android:layout_width="match_parent"
                  android:layout_height="match_parent" />

          </RelativeLayout>
          EOF

          # Create splash_screen.xml for the splash screen
          cat <<EOF > app/src/main/res/layout/splash_screen.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:gravity="center"
              android:background="#000000">

              <ImageView
                  android:id="@+id/splash_icon"
                  android:layout_width="120dp"
                  android:layout_height="120dp"
                  android:src="@mipmap/ic_launcher"
                  android:scaleType="fitCenter"
                  android:layout_marginBottom="20dp" />

              <TextView
                  android:id="@+id/splash_app_name"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="${{ github.event.client_payload.app_name }}"
                  android:textColor="#FFFFFF"
                  android:textSize="24sp"
                  android:textStyle="bold" />

          </LinearLayout>
          EOF

          cat <<EOF > app/src/main/java/com/aite/studio/MainActivity.kt
          package com.aite.studio

          import android.Manifest
          import android.annotation.SuppressLint
          import android.app.NotificationChannel
          import android.app.NotificationManager
          import android.content.Context
          import android.content.Intent
          import android.content.pm.PackageManager
          import android.net.Uri
          import android.os.Build
          import android.os.Bundle
          import android.os.Handler
          import android.os.Looper
          import android.view.View
          import android.view.WindowInsets
          import android.view.WindowManager
          import android.webkit.PermissionRequest
          import android.webkit.ValueCallback
          import android.webkit.WebChromeClient
          import android.webkit.WebResourceRequest
          import android.webkit.WebSettings
          import android.webkit.WebView
          import android.webkit.WebViewClient
          import android.widget.Toast
          import androidx.activity.result.contract.ActivityResultContracts
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.content.ContextCompat

          class MainActivity : AppCompatActivity() {
              private lateinit var webView: WebView
              private var fileUploadCallback: ValueCallback<Array<Uri>>? = null

              // Launchers for Permissions and Files
              private val requestPermissionLauncher = registerForActivityResult(
                  ActivityResultContracts.RequestMultiplePermissions()
              ) { permissions ->
                  // Handle permission results
              }

              private val fileChooserLauncher = registerForActivityResult(
                  ActivityResultContracts.StartActivityForResult()
              ) { result ->
                  if (result.resultCode == RESULT_OK) {
                      val data = result.data?.data
                      if (data != null) {
                          fileUploadCallback?.onReceiveValue(arrayOf(data))
                      } else {
                          fileUploadCallback?.onReceiveValue(null)
                      }
                  } else {
                      fileUploadCallback?.onReceiveValue(null)
                  }
                  fileUploadCallback = null
              }

              @SuppressLint("SetJavaScriptEnabled")
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  
                  // --- Customization Placeholders (Will be replaced by GitHub Actions) ---
                  val enableZoom = "${{ github.event.client_payload.enable_zoom }}".toBoolean()
                  val enableTextSelection = "${{ github.event.client_payload.enable_text_selection }}".toBoolean()
                  val enableSplashScreen = "${{ github.event.client_payload.enable_splash_screen }}".toBoolean()
                  val enableFullScreen = "false".toBoolean() // Keeping this as false for now, can be added later
                  val targetUrl = "${{ github.event.client_payload.app_url }}"
                  // ----------------------------------------------------------------------

                  // 1. Handle Fullscreen (if needed)
                  if (enableFullScreen) {
                      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
                          window.insetsController?.hide(WindowInsets.Type.statusBars())
                      } else {
                          window.setFlags(
                              WindowManager.LayoutParams.FLAG_FULLSCREEN,
                              WindowManager.LayoutParams.FLAG_FULLSCREEN
                          )
                      }
                  }

                  if (enableSplashScreen && savedInstanceState == null) {
                      setContentView(R.layout.splash_screen)
                      Handler(Looper.getMainLooper()).postDelayed({
                          setupWebView(enableZoom, enableTextSelection, targetUrl)
                      }, 2000) // Display splash screen for 2 seconds
                  } else {
                      setupWebView(enableZoom, enableTextSelection, targetUrl)
                  }
                  
                  // 2. Setup Notifications Channel (With Vibration)
                  createNotificationChannel()
                  checkAndRequestPermissions()
              }

              @SuppressLint("SetJavaScriptEnabled")
              private fun setupWebView(enableZoom: Boolean, enableTextSelection: Boolean, targetUrl: String) {
                  setContentView(R.layout.activity_main)
                  webView = findViewById(R.id.webView)
                  val settings = webView.settings
                  settings.javaScriptEnabled = true
                  settings.domStorageEnabled = true
                  settings.allowFileAccess = true
                  settings.allowContentAccess = true
                  settings.mediaPlaybackRequiresUserGesture = false
                  
                  val newUA = settings.userAgentString.replace("; wv", "")
                  settings.userAgentString = newUA
                  
                  // 3. Handle Zoom Customization
                  settings.setSupportZoom(enableZoom)
                  settings.builtInZoomControls = enableZoom
                  settings.displayZoomControls = false

                  // 4. Handle Text Selection Customization
                  if (!enableTextSelection) {
                      webView.setOnLongClickListener { true } // Disables long press context menu
                      webView.isLongClickable = false // Also disable long click for text selection
                      webView.isHapticFeedbackEnabled = false
                  } else {
                      webView.setOnLongClickListener(null)
                      webView.isLongClickable = true
                  }

                  webView.webChromeClient = object : WebChromeClient() {
                      override fun onPermissionRequest(request: PermissionRequest?) {
                          request?.grant(request.resources)
                      }

                      override fun onShowFileChooser(
                          webView: WebView?,
                          filePathCallback: ValueCallback<Array<Uri>>?,
                          fileChooserParams: FileChooserParams?
                      ): Boolean {
                          fileUploadCallback = filePathCallback
                          val intent = Intent(Intent.ACTION_GET_CONTENT)
                          intent.type = "*/*"
                          fileChooserLauncher.launch(intent)
                          return true
                      }
                  }

                  // 5. Handle External Links & Apps
                  webView.webViewClient = object : WebViewClient() {
                      override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?): Boolean {
                          val url = request?.url.toString()
                          
                          // Keep app's own links inside WebView
                          if (url.startsWith("http") || url.startsWith("https")) {
                              if (url.contains(Uri.parse(targetUrl).host ?: "")) {
                                  return false 
                              }
                              // Open other websites in external browser
                              try {
                                  val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
                                  startActivity(intent)
                              } catch (e: Exception) {
                                  e.printStackTrace()
                              }
                              return true
                          } 
                          
                          // Handle Schemes (tel:, mailto:, whatsapp:, intent:)
                          try {
                              val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
                              startActivity(intent)
                              return true
                          } catch (e: Exception) {
                              // App not installed
                              return true
                          }
                      }
                  }

                  webView.loadUrl(targetUrl)
              }

              private fun createNotificationChannel() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      val name = "App Notifications"
                      val descriptionText = "Default Channel"
                      val importance = NotificationManager.IMPORTANCE_HIGH
                      val channel = NotificationChannel("DEFAULT_CHANNEL", name, importance).apply {
                          description = descriptionText
                          enableVibration(true) // Force Vibration
                      }
                      val notificationManager: NotificationManager =
                          getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
                      notificationManager.createNotificationChannel(channel)
                  }
              }

              private fun checkAndRequestPermissions() {
                  val permissionsToRequest = mutableListOf<String>()
                  
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) != PackageManager.PERMISSION_GRANTED) {
                      permissionsToRequest.add(Manifest.permission.CAMERA)
                  }
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) != PackageManager.PERMISSION_GRANTED) {
                      permissionsToRequest.add(Manifest.permission.RECORD_AUDIO)
                  }
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
                      permissionsToRequest.add(Manifest.permission.ACCESS_FINE_LOCATION)
                  }

                  // Notification Permission for Android 13+
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                      if (ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                          permissionsToRequest.add(Manifest.permission.POST_NOTIFICATIONS)
                      }
                  }
                  
                  if (permissionsToRequest.isNotEmpty()) {
                      requestPermissionLauncher.launch(permissionsToRequest.toTypedArray())
                  }
              }

              override fun onBackPressed() {
                  if (::webView.isInitialized && webView.canGoBack()) { // Check if webView is initialized
                      webView.goBack()
                  } else {
                      super.onBackPressed()
                  }
              }
          }
          EOF

      - name: Download Icon
        run: |
          echo "Downloading icon from: ${{ github.event.client_payload.icon_url }}"
          curl -L "${{ github.event.client_payload.icon_url }}" -o icon_raw
          if [ ! -s icon_raw ]; then
             echo "Error: Icon file is empty or download failed."
             exit 1
          fi

      - name: Process and Place Icon
        run: |
          convert icon_raw -resize 48x48 app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert icon_raw -resize 72x72 app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert icon_raw -resize 96x96 app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert icon_raw -resize 144x144 app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert icon_raw -resize 192x192 app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

      - name: Build APK
        run: chmod +x gradlew && ./gradlew assembleDebug

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}
          name: App Build ${{ github.run_id }}
          files: app/build/outputs/apk/debug/app-debug.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send to Telegram
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "✅ تم بناء تطبيق جديد بنجاح!\n\nاسم التطبيق: ${{ github.event.client_payload.app_name }}\nرابط الموقع: ${{ github.event.client_payload.app_url }}"
          document: app/build/outputs/apk/debug/app-debug.apk
